<!DOCTYPE html>
<html>
<head>
    <title>Trends by Keyword</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define("Calculator",{config:{keywords:[],bucketBy:"",aggregateBy:""},constructor:function(config){this.initConfig(config)},prepareChartData:function(store){var groupedData=this._groupData(store.getRange()),categories=_.keys(groupedData),seriesData=_.reduce(this.keywords,function(accum,keyword){return accum[keyword]=[],accum},{});return _.each(categories,function(category){var data=groupedData[category];_.each(this.keywords,function(keyword){var val=0,matcher=new RegExp(keyword,"gi");_.each(data,function(item){var name=item.get("Name"),description=item.get("Description");(matcher.test(name)||matcher.test(description))&&(val+="count"===this.aggregateBy?1:item.get("PlanEstimate")||0)},this),seriesData[keyword].push(val)},this)},this),{categories:categories,series:_.map(this.keywords,function(keyword){return{name:keyword,data:seriesData[keyword]}})}},_groupData:function(records){return _.groupBy(records,function(record){var endDate=record.get("AcceptedDate");return"month"===this.bucketBy?moment(endDate).startOf("month").format("MMM 'YY"):"quarter"===this.bucketBy?moment(endDate).startOf("quarter").format("YYYY [Q]Q"):"release"===this.bucketBy?record.get("Release")._refObjectName:"year"===this.bucketBy?moment(endDate).startOf("year").format("YYYY"):void 0},this)}});
                Ext.define("TrendsByKeywordApp",{extend:"Rally.app.App",componentCls:"app",layout:"fit",autoScroll:!1,requires:["Calculator"],config:{defaultSettings:{keywords:"",aggregateBy:"points",bucketBy:"release",query:""}},launch:function(){this.getSetting("keywords")?this._addChart():Rally.ui.notify.Notifier.showError({message:"No keywords specified.  Please edit settings to continue."})},getSettingsFields:function(){return[{name:"keywords",xtype:"rallytextfield",plugins:["rallyfieldvalidationui"],fieldLabel:"Keywords",allowBlank:!1},{name:"aggregateBy",xtype:"rallycombobox",plugins:["rallyfieldvalidationui"],fieldLabel:"Aggregate By",displayField:"name",valueField:"value",editable:!1,allowBlank:!1,width:300,store:{fields:["name","value"],data:[{name:"Points",value:"points"},{name:"Count",value:"count"}]},lastQuery:""},{name:"bucketBy",xtype:"rallycombobox",plugins:["rallyfieldvalidationui"],fieldLabel:"Bucket By",displayField:"name",valueField:"value",editable:!1,allowBlank:!1,store:{fields:["name","value"],data:[{name:"Month",value:"month"},{name:"Quarter",value:"quarter"},{name:"Release",value:"release"},{name:"Year",value:"year"}]},lastQuery:""},{type:"query"}]},_addChart:function(){var context=this.getContext(),whiteListFields=["Milestones","Tags"],modelNames=["HierarchicalRequirement","Defect"],gridBoardConfig={xtype:"rallygridboard",toggleState:"chart",chartConfig:this._getChartConfig(),plugins:[{ptype:"rallygridboardinlinefiltercontrol",showInChartMode:!0,inlineFilterButtonConfig:{stateful:!0,stateId:context.getScopedStateId("filters"),filterChildren:!1,modelNames:modelNames,inlineFilterPanelConfig:{quickFilterPanelConfig:{defaultFields:[],addQuickFilterConfig:{whiteListFields:whiteListFields}},advancedFilterPanelConfig:{advancedFilterRowsConfig:{propertyFieldConfig:{whiteListFields:whiteListFields}}}}}},{ptype:"rallygridboardactionsmenu",menuItems:[{text:"Export to CSV...",handler:function(){window.location=Rally.ui.gridboard.Export.buildCsvExportUrl(this.down("rallygridboard").getGridOrBoard())},scope:this}],buttonConfig:{iconCls:"icon-export",toolTipConfig:{html:"Export",anchor:"top",hideDelay:0}}}],context:context,modelNames:modelNames,storeConfig:{filters:this._getFilters()}};this.add(gridBoardConfig)},_getChartConfig:function(){return{xtype:"rallychart",chartColors:["#FF8200","#F6A900","#FAD200","#8DC63F","#1E7C00","#337EC6","#005EB8","#7832A5","#DA1884","#C0C0C0"],storeType:"Rally.data.wsapi.artifact.Store",storeConfig:{context:this.getContext().getDataContext(),limit:1/0,fetch:this._getChartFetch(),sorters:this._getChartSort(),pageSize:2e3,models:["HierarchicalRequirement","Defect"]},calculatorType:"Calculator",calculatorConfig:{keywords:this._getKeywordsSetting(),bucketBy:this.getSetting("bucketBy"),aggregateBy:this.getSetting("aggregateBy")},chartConfig:{chart:{type:"area"},title:{text:""},yAxis:{min:0,title:{text:this._getYAxisLabel()}},plotOptions:{area:{stacking:"normal"}}}}},onTimeboxScopeChange:function(){this.callParent(arguments);var gridBoard=this.down("rallygridboard");gridBoard&&gridBoard.destroy(),this._addChart()},_getYAxisLabel:function(){var estimateUnitName=this.getContext().getWorkspace().WorkspaceConfiguration.ReleaseEstimateUnitName;return"count"===this.getSetting("aggregateBy")?"Count":estimateUnitName},_getChartFetch:function(){return _.compact(["FormattedID","Name","Description","AcceptedDate","PlanEstimate","Release"])},_getChartSort:function(){return this._isByRelease()?[{property:"Release.ReleaseDate",direction:"ASC"}]:[{property:"CreationDate",direction:"ASC"}]},_getKeywordsSetting:function(){return this.getSetting("keywords").split(",")},_getFilters:function(){var keywords=this._getKeywordsSetting(),queries=[Rally.data.wsapi.Filter.or(_.flatten(_.map(keywords,function(keyword){return[{property:"Name",operator:"contains",value:keyword},{property:"Description",operator:"contains",value:keyword}]})))];this._isByRelease()&&queries.push({property:"Release",operator:"!=",value:null});var timeboxScope=this.getContext().getTimeboxScope();return timeboxScope&&queries.push(timeboxScope.getQueryFilter()),this.getSetting("query")&&queries.push(Rally.data.QueryFilter.fromQueryString(this.getSetting("query"))),queries},_isByRelease:function(){return"release"===this.getSetting("bucketBy")}});

            Rally.launchApp('TrendsByKeywordApp', {
                name:"Trends by Keyword",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
